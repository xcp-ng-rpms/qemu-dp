From 3424aa9cbd67caa797fddf0e9256c8981821226e Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.fr>
Date: Tue, 3 Aug 2021 15:13:59 +0200
Subject: [PATCH] qmp_xen_watch_device support 9pfs

---
 Makefile             | 15 ++++++++++++++-
 dp-stub.c            |  5 ++++-
 hw/xen/xen_backend.c | 19 ++++++++++++++++---
 qemu-dp.c            |  4 ++++
 4 files changed, 38 insertions(+), 5 deletions(-)

diff --git a/Makefile b/Makefile
index 31758b61e5..f32b3ff3f7 100644
--- a/Makefile
+++ b/Makefile
@@ -621,7 +621,20 @@ qemu-dp$(EXESUF): \
     hw/block/xen_disk.o hw/xen/xen_devconfig.o hw/xen/xen_backend.o hw/xen/xen_pvdev.o hw/xen/xen_backend.o \
     hw/core/qdev.o hw/core/bus.o hw/core/hotplug.o hw/core/qdev-properties.o hw/core/irq.o \
     hw/core/fw-path-provider.o hw/core/reset.o chardev/char-socket.o \
-    \
+
+ifdef CONFIG_VIRTFS
+qemu-dp$(EXESUF): \
+    fsdev/qemu-fsdev.o fsdev/9p-marshal.o fsdev/9p-iov-marshal.o \
+    fsdev/qemu-fsdev-opts.o fsdev/qemu-fsdev-throttle.o \
+    hw/9pfs/9p.o hw/9pfs/9p-util.o hw/9pfs/9p-local.o hw/9pfs/9p-xattr.o hw/9pfs/xen-9p-backend.o \
+    hw/9pfs/9p-xattr-user.o hw/9pfs/9p-posix-acl.o \
+    hw/9pfs/coth.o hw/9pfs/cofs.o hw/9pfs/codir.o hw/9pfs/cofile.o \
+    hw/9pfs/coxattr.o hw/9pfs/9p-synth.o \
+    hw/9pfs/9p-handle.o hw/9pfs/9p-proxy.o \
+    hw/9pfs/xen-9p-backend.o
+endif
+
+qemu-dp$(EXESUF): \
     libqemudpqapi.a libqemuchardev.a libqemublock.a libqemuio.a libqemuqom.a \
     libqemucommondp.a libqemuutil.a libqemucrypto.a
 
diff --git a/dp-stub.c b/dp-stub.c
index 142fecb68b..ee719377e8 100644
--- a/dp-stub.c
+++ b/dp-stub.c
@@ -7,9 +7,12 @@
 
 struct XenDevOps xen_console_ops;
 struct XenDevOps xen_kbdmouse_ops;
-struct XenDevOps xen_9pfs_ops;
 struct XenDevOps xen_usb_ops;
 
+#ifndef CONFIG_VIRTFS
+    struct XenDevOps xen_9pfs_ops;
+#endif
+
 void monitor_printf(Monitor *mon, const char *fmt, ...)
 {
 }
diff --git a/hw/xen/xen_backend.c b/hw/xen/xen_backend.c
index 511cc032ba..1c5e6804ed 100644
--- a/hw/xen/xen_backend.c
+++ b/hw/xen/xen_backend.c
@@ -876,8 +876,15 @@ static void xenbe_register_types(void)
 void qmp_xen_watch_device(int64_t domid, int64_t devid, const char *type, const char *blocknode, const char *devicename, Error **errp)
 {
     struct XenDevice *xendev = NULL;
+    const int is_qdisk = !strcmp(type, "qdisk");
 
-    if (strcmp(type, "qdisk")) {
+    #ifdef CONFIG_VIRTFS
+      const int is_9pfs = !is_qdisk && !strcmp(type, "9pfs");
+    #else
+      const int is_9pfs = 0;
+    #endif
+
+    if (!is_qdisk && !is_9pfs) {
         error_set(errp, ERROR_CLASS_DEVICE_NOT_FOUND,
                   "Device type '%s' not supported", type);
         return;
@@ -889,10 +896,16 @@ void qmp_xen_watch_device(int64_t domid, int64_t devid, const char *type, const
      * Hence we check the argument matches "qdisk" above but we never use it
      * otherwise.
      */
-    xendev = xen_be_get_xendev("qdisk", domid, devid, &xen_blkdev_ops);
+    if (is_qdisk)
+      xendev = xen_be_get_xendev("qdisk", domid, devid, &xen_blkdev_ops);
+    #ifdef CONFIG_VIRTFS
+    else
+      xendev = xen_be_get_xendev("9pfs", domid, devid, &xen_9pfs_ops);
+    #endif
+
     if (xendev == NULL) {
         error_set(errp, ERROR_CLASS_DEVICE_NOT_FOUND,
-                  "Device type '%s-%ld' not found in domain %ld", "qdisk", devid, domid);
+                  "Device type '%s-%ld' not found in domain %ld", type, devid, domid);
         return;
     }
     xendev->blocknode = g_strdup(blocknode);
diff --git a/qemu-dp.c b/qemu-dp.c
index 751a82931f..38e0cc1623 100644
--- a/qemu-dp.c
+++ b/qemu-dp.c
@@ -121,6 +121,10 @@ int main(int argc, char **argv)
     qemu_mutex_lock_iothread();
 
     qemu_add_opts(&qemu_chardev_opts);
+
+    // Ensure all options are added in QEMU (like "fsdev" in the xen 9pfs driver).
+    module_call_init(MODULE_INIT_OPTS);
+
     qmparg = g_strdup_printf("unix:%s,server,nowait", argv[1]);
     opts = qemu_chr_parse_compat("monitor0", qmparg);
     g_free(qmparg);
-- 
2.32.0

